% -*- coding: utf-8 -*-
\documentclass{book}

\input{preamble}
\setcounter{chapter}{1}

\begin{document}

%\chapter{Category Codes and Internal States}\label{mouth}
\chapter{Category Codes and Internal States}\label{mouth}

%When characters are read, 
%\TeX\ assigns them
%category codes. The reading mechanism has three internal
%states, and transitions between these states are affected
%by category codes of characters in the input.
%This chapter describes how \TeX\ reads its input and
%how the category codes of characters influence the
%reading behaviour. Spaces and line ends are discussed.
When characters are read, 
\TeX\ assigns them
category codes. The reading mechanism has three internal
states, and transitions between these states are affected
by category codes of characters in the input.
This chapter describes how \TeX\ reads its input and
how the category codes of characters influence the
reading behaviour. Spaces and line ends are discussed.

%\label{cschap:endlinechar}\label{cschap:ignorespaces}\label{cschap:catcode}\label{cschap:char32}\label{cschap:obeylines}\label{cschap:obeyspaces}
%\begin{inventory}
%\item [\cs{endlinechar}]  
%      The character code of the end-of-line character 
%      appended to input lines.
%      \IniTeX\ default:~13.
%\item [\cs{par}]  
%      Command to close off a paragraph and go into vertical mode.
%      Is generated by empty lines.
\label{cschap:endlinechar}\label{cschap:ignorespaces}\label{cschap:catcode}\label{cschap:char32}\label{cschap:obeylines}\label{cschap:obeyspaces}
\begin{inventory}
\item [\cs{endlinechar}]  
      The character code of the end-of-line character 
      appended to input lines.
      \IniTeX\ default:~13.
\item [\cs{par}]  
      Command to close off a paragraph and go into vertical mode.
      Is generated by empty lines.

%\item [\cs{ignorespaces}]   
%      Command that reads and expands until something is
%      encountered that is not a \gr{space token}.
\item [\cs{ignorespaces}]   
      Command that reads and expands until something is
      encountered that is not a \gr{space token}.

%\item [\cs{catcode}] 
%      Query or set category codes.
\item [\cs{catcode}] 
      Query or set category codes.

%\item [\cs{ifcat}]  
%      Test whether two characters have the same category code.
\item [\cs{ifcat}]  
      Test whether two characters have the same category code.

%\item [\cs{\char32}]
%      Control space.
%      Insert the same amount of space that a space token would
%      when \cs{spacefactor}${}=1000$.
\item [\cs{\char32}]
      Control space.
      Insert the same amount of space that a space token would
      when \cs{spacefactor}${}=1000$.

%\item [\cs{obeylines}]
%      Macro in plain \TeX\ to make line ends significant.
\item [\cs{obeylines}]
      Macro in plain \TeX\ to make line ends significant.

%\item [\cs{obeyspaces}]
%      Macro in plain \TeX\ to make (most) spaces significant.
%\end{inventory}
\item [\cs{obeyspaces}]
      Macro in plain \TeX\ to make (most) spaces significant.
\end{inventory}

%\section{Introduction}
\section{Introduction}

%\TeX's input processor scans input lines from a file or terminal, and
%makes tokens out of the characters.
%The input processor can be viewed as
%a simple finite state automaton with three internal states; 
%depending on the state its scanning behaviour may differ.
%This automaton will be treated here both from the point of view of the
%internal states and of the category codes governing the
%transitions.
\TeX's input processor scans input lines from a file or terminal, and
makes tokens out of the characters.
The input processor can be viewed as
a simple finite state automaton with three internal states; 
depending on the state its scanning behaviour may differ.
This automaton will be treated here both from the point of view of the
internal states and of the category codes governing the
transitions.

%\section{Initial processing}
\section{Initial processing}

%Input from a file (or from the user terminal, but this
%will not be mentioned specifically
%most of the time) is handled one line at a time.
%Here follows a discussion of what exactly is an input line
%for \TeX.
Input from a file (or from the user terminal, but this
will not be mentioned specifically
most of the time) is handled one line at a time.
Here follows a discussion of what exactly is an input line
for \TeX.

%Computer systems differ with respect to 
%\index{line! input}\index{line! end}\index{machine independence}
%the exact definition of an input
%\mdqon
%line. The carriage return/""line feed
%\mdqoff
%\message{slash-dash}%
%sequence terminating a line is most common,
%but some systems use just a line feed, and
%some systems with fixed record length (block) storage do not have
%a line terminator at all. Therefore \TeX\ has its
%own way of terminating an input line.
Computer systems differ with respect to 
\index{line! input}\index{line! end}\index{machine independence}
the exact definition of an input
\mdqon
line. The carriage return/""line feed
\mdqoff
\message{slash-dash}%
sequence terminating a line is most common,
but some systems use just a line feed, and
some systems with fixed record length (block) storage do not have
a line terminator at all. Therefore \TeX\ has its
own way of terminating an input line.

%\begin{enumerate}
%\item An input line is read from an input file  (minus the
%line terminator, if any).
%\item Trailing spaces are removed (this is for the systems
%with block storage, and it prevents confusion because these
%spaces are hard to see in an editor).
%\item The \csterm endlinechar\par, by default \gram{return}
%(code~13) is appended.
%If the value of \cs{endlinechar} is negative
%\label{append:elc}%
%or more than~255 (this was 127 in versions of \TeX\ older
%than version~3; see page~\pageref{2vs3} for more differences),
%no character is appended. 
%The effect then is the same as
%if the line were to end with a comment character.
%\end{enumerate}
\begin{enumerate}
\item An input line is read from an input file  (minus the
line terminator, if any).
\item Trailing spaces are removed (this is for the systems
with block storage, and it prevents confusion because these
spaces are hard to see in an editor).
\item The \csterm endlinechar\par, by default \gram{return}
(code~13) is appended.
If the value of \cs{endlinechar} is negative
\label{append:elc}%
or more than~255 (this was 127 in versions of \TeX\ older
than version~3; see page~\pageref{2vs3} for more differences),
no character is appended. 
The effect then is the same as
if the line were to end with a comment character.
\end{enumerate}


%Computers may also differ in the character encoding
%(the most common schemes are \ascii{} and \ebcdic{}), so \TeX\
%converts the characters that are read from the file to its
%own character codes. These codes are then used exclusively,
%so that \TeX\ will perform the same on any system.
%For more on this, see Chapter~\ref{char}.
Computers may also differ in the character encoding
(the most common schemes are \ascii{} and \ebcdic{}), so \TeX\
converts the characters that are read from the file to its
own character codes. These codes are then used exclusively,
so that \TeX\ will perform the same on any system.
For more on this, see Chapter~\ref{char}.

%\section{Category codes}
\section{Category codes}

%Each of the 256 character codes (0--255) has an
%associated \indexterm{category code}, though not necessarily always the same one.
%There are 16 categories, numbered 0--15. 
%When scanning the input, \TeX\
%thus forms character-code--category-code pairs.
%The input processor sees only these pairs; from them are formed
%character tokens, control sequence tokens, and parameter tokens.
%These tokens are then passed to \TeX's expansion and execution
%processes.
Each of the 256 character codes (0--255) has an
associated \indexterm{category code}, though not necessarily always the same one.
There are 16 categories, numbered 0--15. 
When scanning the input, \TeX\
thus forms character-code--category-code pairs.
The input processor sees only these pairs; from them are formed
character tokens, control sequence tokens, and parameter tokens.
These tokens are then passed to \TeX's expansion and execution
processes.

%A~character token is a character-code--category-code
%pair that is passed unchanged.
%A~control sequence token consists of one or more characters
%preceded by an escape character; see below.
%Parameter tokens are also explained below.
A~character token is a character-code--category-code
pair that is passed unchanged.
A~control sequence token consists of one or more characters
preceded by an escape character; see below.
Parameter tokens are also explained below.

%This is the list of the categories, together with a brief
%description. More elaborate explanations follow in this and
%later chapters.
%\begin{enumerate} \message{set counter}%\SetCounter:item=-1
%\setcounter{enumi}{-1}
%\item\label{ini:esc}\index{category!0} Escape character; this signals
%  the start of a control sequence. \IniTeX\ makes the backslash
%  \verb-\- (code~92) an escape character.
%\item\index{category!1} Beginning of group; such a character causes
%  \TeX\ to enter a new level of grouping. The plain format makes the
%  open brace \verb-{- \mdqon a beginning"-of-group character.  \mdqoff
%\item\index{category!2} End of group; \TeX\ closes the current level
%  of grouping.  Plain \TeX\ has the closing brace \verb-}- as
%  end-of-group character.
%\item\index{category!3} Math shift; this is the opening and closing
%  delimiter for math formulas. Plain \TeX\ uses the dollar
%  sign~\verb-$- for this.
%\item\index{category!4} Alignment tab; the column (row) separator in
%  tables made with \cs{halign} (\cs{valign}). In plain \TeX\ this is
%  the ampersand~\verb-&-.
%\item\index{category!5}\label{ini:eol} End of line; a character that
%  \TeX\ considers to signal the end of an input line.
%  \IniTeX\ assigns this code to the \gram{return}, that is, code~13.
%  Not coincidentally, 13~is also the value that \IniTeX\ assigns to
%  the \cs{endlinechar} parameter; see above.
%\item\index{category!6} Parameter character; this indicates parameters
%  for macros.  In plain \TeX\ this is the hash sign~\verb-#-.
%\item\index{category!7} Superscript; this precedes superscript
%  expressions in math mode. It is also used to denote character codes
%  that cannot be entered in an input file; see below.  In plain
%  \TeX\ this is the circumflex~\verb-^-.
%\item\index{category!8} Subscript; this precedes subscript expressions
%  in math mode.  In plain \TeX\ the underscore~\verb-_- is used for
%  this.
%\item\index{category!9} Ignored; characters of this category are
%  removed from the input, and have therefore no influence on further
%  \TeX\ processing. In plain \TeX\ this is the \gr{null} character,
%  that is, code~0.
%\item\index{category!10}\label{ini:sp} Space; space characters receive
%  special treatment.  \IniTeX\ assigns this category to the \ascii{}
%  \gr{space} character, code~32.
%\item\index{category!11}\label{ini:let} Letter; in \IniTeX\ only the
%  characters \n{a..z}, \n{A..Z} are in this category. Often, macro
%  packages make some `secret' character (for instance~\n@) into a
%  letter.
%\item\index{category!12}\label{ini:other} Other; \IniTeX\ puts
%  everything that is not in the other categories into this
%  category. Thus it includes, for instance, digits and punctuation.
%\item\index{category!13} Active; active characters function as a
%  \TeX\ command, without being preceded by an escape character.  In
%  plain \TeX\ this is only the tie character~\verb-~-, which is
%  defined to produce an unbreakable space; see page~\pageref{tie}.
%\item\index{category!14}\label{ini:comm} Comment character; from a
%  comment character onwards, \TeX\ considers the rest of an input line
%  to be comment and ignores it. In \IniTeX\ the per cent sign \verb-%-
%  is made a comment character.
%\item\index{category!15}\label{ini:invalid} Invalid character; this
%  category is for characters that should not appear in the
%  input. \IniTeX\ assigns the \ascii\ \gr{delete} character, code~127,
%  to this category.
%\end{enumerate}
This is the list of the categories, together with a brief
description. More elaborate explanations follow in this and
later chapters.
\begin{enumerate} \message{set counter}%\SetCounter:item=-1
\setcounter{enumi}{-1}
\item\label{ini:esc}\index{category!0} Escape character; this signals
  the start of a control sequence. \IniTeX\ makes the backslash
  \verb-\- (code~92) an escape character.
\item\index{category!1} Beginning of group; such a character causes
  \TeX\ to enter a new level of grouping. The plain format makes the
  open brace \verb-{- \mdqon a beginning"-of-group character.  \mdqoff
\item\index{category!2} End of group; \TeX\ closes the current level
  of grouping.  Plain \TeX\ has the closing brace \verb-}- as
  end-of-group character.
\item\index{category!3} Math shift; this is the opening and closing
  delimiter for math formulas. Plain \TeX\ uses the dollar
  sign~\verb-$- for this.
\item\index{category!4} Alignment tab; the column (row) separator in
  tables made with \cs{halign} (\cs{valign}). In plain \TeX\ this is
  the ampersand~\verb-&-.
\item\index{category!5}\label{ini:eol} End of line; a character that
  \TeX\ considers to signal the end of an input line.
  \IniTeX\ assigns this code to the \gram{return}, that is, code~13.
  Not coincidentally, 13~is also the value that \IniTeX\ assigns to
  the \cs{endlinechar} parameter; see above.
\item\index{category!6} Parameter character; this indicates parameters
  for macros.  In plain \TeX\ this is the hash sign~\verb-#-.
\item\index{category!7} Superscript; this precedes superscript
  expressions in math mode. It is also used to denote character codes
  that cannot be entered in an input file; see below.  In plain
  \TeX\ this is the circumflex~\verb-^-.
\item\index{category!8} Subscript; this precedes subscript expressions
  in math mode.  In plain \TeX\ the underscore~\verb-_- is used for
  this.
\item\index{category!9} Ignored; characters of this category are
  removed from the input, and have therefore no influence on further
  \TeX\ processing. In plain \TeX\ this is the \gr{null} character,
  that is, code~0.
\item\index{category!10}\label{ini:sp} Space; space characters receive
  special treatment.  \IniTeX\ assigns this category to the \ascii{}
  \gr{space} character, code~32.
\item\index{category!11}\label{ini:let} Letter; in \IniTeX\ only the
  characters \n{a..z}, \n{A..Z} are in this category. Often, macro
  packages make some `secret' character (for instance~\n@) into a
  letter.
\item\index{category!12}\label{ini:other} Other; \IniTeX\ puts
  everything that is not in the other categories into this
  category. Thus it includes, for instance, digits and punctuation.
\item\index{category!13} Active; active characters function as a
  \TeX\ command, without being preceded by an escape character.  In
  plain \TeX\ this is only the tie character~\verb-~-, which is
  defined to produce an unbreakable space; see page~\pageref{tie}.
\item\index{category!14}\label{ini:comm} Comment character; from a
  comment character onwards, \TeX\ considers the rest of an input line
  to be comment and ignores it. In \IniTeX\ the per cent sign \verb-%-
  is made a comment character.
\item\index{category!15}\label{ini:invalid} Invalid character; this
  category is for characters that should not appear in the
  input. \IniTeX\ assigns the \ascii\ \gr{delete} character, code~127,
  to this category.
\end{enumerate}

%The user can change the mapping 
%of character codes to category codes
%with the \csterm catcode\par\ command (see Chapter~\ref{gramm}
%for the explanation of concepts such as~\gr{equals}):
%\begin{disp}\cs{catcode}\gram{number}\gr{equals}\gram{number}.\end{disp}
%In such a statement, the first number is often given in the form
%\begin{disp}\verb>`>\gr{character}\quad or\quad \verb>`\>\gr{character}\end{disp}
%both of which denote the character code of the character
%(see pages \pageref{char:code} and~\pageref{int:denotation}).
The user can change the mapping 
of character codes to category codes
with the \csterm catcode\par\ command (see Chapter~\ref{gramm}
for the explanation of concepts such as~\gr{equals}):
\begin{disp}\cs{catcode}\gram{number}\gr{equals}\gram{number}.\end{disp}
In such a statement, the first number is often given in the form
\begin{disp}\verb>`>\gr{character}\quad or\quad \verb>`\>\gr{character}\end{disp}
both of which denote the character code of the character
(see pages \pageref{char:code} and~\pageref{int:denotation}).

%The plain format defines
%\csterm active\par
%\begin{verbatim}
%\chardef\active=13
%\end{verbatim} 
%so that one can write statements such as
%\begin{verbatim}
%\catcode`\{=\active
%\end{verbatim}
%The \cs{chardef} command is  treated
%on pages \pageref{chardef} and~\pageref{num:chardef}.
The plain format defines
\csterm active\par
\begin{verbatim}
\chardef\active=13
\end{verbatim} 
so that one can write statements such as
\begin{verbatim}
\catcode`\{=\active
\end{verbatim}
The \cs{chardef} command is  treated
on pages \pageref{chardef} and~\pageref{num:chardef}.

%The \LaTeX\ format has the control sequences
%\begin{verbatim}
%\def\makeatletter{\catcode`@=11 }
%\def\makeatother{\catcode`@=12 }
%\end{verbatim}
%in order to switch on and off the `secret' character~\n@
%(see below).
The \LaTeX\ format has the control sequences
\begin{verbatim}
\def\makeatletter{\catcode`@=11 }
\def\makeatother{\catcode`@=12 }
\end{verbatim}
in order to switch on and off the `secret' character~\n@
(see below).

%The \cs{catcode} command can also be used to query category
%codes: in 
%\begin{verbatim}
%\count255=\catcode`\{
%\end{verbatim}
%it yields a number, which can be assigned.
The \cs{catcode} command can also be used to query category
codes: in 
\begin{verbatim}
\count255=\catcode`\{
\end{verbatim}
it yields a number, which can be assigned.

%Category codes can be tested by
%\begin{disp}\cs{ifcat}\gr{token$_1$}\gr{token$_2$}\end{disp}
%\TeX\ expands whatever is after \cs{ifcat} until two 
%unexpandable tokens are found; these are then compared
%with respect to their category codes. Control sequence
%tokens are considered to have category code~16\index{category!16},
%which makes them all equal to each other, and unequal to
%all character tokens.
%Conditionals are treated further in Chapter~\ref{if}.
Category codes can be tested by
\begin{disp}\cs{ifcat}\gr{token$_1$}\gr{token$_2$}\end{disp}
\TeX\ expands whatever is after \cs{ifcat} until two 
unexpandable tokens are found; these are then compared
with respect to their category codes. Control sequence
tokens are considered to have category code~16\index{category!16},
which makes them all equal to each other, and unequal to
all character tokens.
Conditionals are treated further in Chapter~\ref{if}.

%\section{From characters to tokens}
\section{From characters to tokens}

%The input processor
%of \TeX\ scans input lines from a file or from the
%user terminal, and converts the characters in the input
%to tokens. There are three types of tokens.
%\begin{itemize}\item Character tokens: any character that is
%	passed on its own to \TeX's
%further levels of processing with an appropriate
%category code attached.
%\item Control sequence tokens, of which there are two kinds:
%	an escape character 
%\ldash that is,\message{ldash nobreak?}
%a character of category~0\index{category!0} \rdash  followed
%by a string of `letters' is
%lumped together into a {\em control word}, which is a single token.
%An escape character followed by a single character that is not of
%category~11\index{category!11}, letter, is made into a 
%\indextermsub{control}{symbol}.
%If the distinction between control word and control symbol is
%irrelevant, both are called 
%\indextermsub{control}{sequence}.
The input processor
of \TeX\ scans input lines from a file or from the
user terminal, and converts the characters in the input
to tokens. There are three types of tokens.
\begin{itemize}\item Character tokens: any character that is
	passed on its own to \TeX's
further levels of processing with an appropriate
category code attached.
\item Control sequence tokens, of which there are two kinds:
	an escape character 
\ldash that is,\message{ldash nobreak?}
a character of category~0\index{category!0} \rdash  followed
by a string of `letters' is
lumped together into a {\em control word}, which is a single token.
An escape character followed by a single character that is not of
category~11\index{category!11}, letter, is made into a 
\indextermsub{control}{symbol}.
If the distinction between control word and control symbol is
irrelevant, both are called 
\indextermsub{control}{sequence}.

%The control symbol that results from an escape character followed
%\csterm \char32\par
%by a space character is called 
%\indextermbus{control}{space}.
The control symbol that results from an escape character followed
\csterm \char32\par
by a space character is called 
\indextermbus{control}{space}.

%\item Parameter tokens: a parameter character \ldash that is, a
%  character of category~6\index{category!6}, by default~\verb=#=
%  \rdash followed by a digit \n{1..9} is replaced by a parameter
%  token.  Parameter tokens are allowed only in the context of macros
%  (see Chapter~\ref{macro}).
\item Parameter tokens: a parameter character \ldash that is, a
  character of category~6\index{category!6}, by default~\verb=#=
  \rdash followed by a digit \n{1..9} is replaced by a parameter
  token.  Parameter tokens are allowed only in the context of macros
  (see Chapter~\ref{macro}).

%A macro parameter character followed by another macro parameter
%character (not necessarily with the same character code)
%is replaced by a single character token.
%This token has category~6 (macro parameter), and the character
%code of the second parameter character.
%The most common instance is of this is
%replacing \n{\#\#} by~\n{\#$_6$}, where the subscript
%denotes the category code.
A macro parameter character followed by another macro parameter
character (not necessarily with the same character code)
is replaced by a single character token.
This token has category~6 (macro parameter), and the character
code of the second parameter character.
The most common instance is of this is
replacing \n{\#\#} by~\n{\#$_6$}, where the subscript
denotes the category code.

%\end{itemize}
\end{itemize}

%\section{The input processor as a finite state automaton}
%\label{input:states}
\section{The input processor as a finite state automaton}
\label{input:states}

%\TeX's input processor can be considered to be a finite state 
%automaton with three \indextermbus{internal}{states},
%that is, at any moment in time it is in one of three states,
%and after transition to another state there is no memory of the
%previous states. 
\TeX's input processor can be considered to be a finite state 
automaton with three \indextermbus{internal}{states},
that is, at any moment in time it is in one of three states,
and after transition to another state there is no memory of the
previous states. 

%\subsection{State {\italic N}: new line}
\subsection{State {\italic N}: new line}

%State {\italic N} is entered at the beginning of each new input line,
%and that is the only time \TeX\ is in this state.  In state~{\italic
%  N} all space tokens (that is, characters of
%category~10\index{category!10}) are ignored; an end-of-line character
%is converted into a \cs{par} token.  All other tokens bring \TeX\ into
%state~{\italic M}.
State {\italic N} is entered at the beginning of each new input line,
and that is the only time \TeX\ is in this state.  In state~{\italic
  N} all space tokens (that is, characters of
category~10\index{category!10}) are ignored; an end-of-line character
is converted into a \cs{par} token.  All other tokens bring \TeX\ into
state~{\italic M}.

%\subsection{State {\italic S}: skipping spaces}
\subsection{State {\italic S}: skipping spaces}

%State {\italic S} is entered in any mode after a control word or
%control space (but after no other control symbol),
%or, when in state~{\italic M}, after a space.
%In this state all subsequent spaces or end-of-line characters
%in this input line are discarded.
State {\italic S} is entered in any mode after a control word or
control space (but after no other control symbol),
or, when in state~{\italic M}, after a space.
In this state all subsequent spaces or end-of-line characters
in this input line are discarded.

%%\spoint State {\italic M}: middle of line
%\subsection{State {\italic M}: middle of line}
%\spoint State {\italic M}: middle of line
\subsection{State {\italic M}: middle of line}

%By far the most common state is~{\italic M}, `middle of line'.
%It is entered after characters of categories
%1--4, 6--8, and 11--13, and after control symbols
%other than control space.
%An end-of-line character encountered in this state
%results in a space token.
By far the most common state is~{\italic M}, `middle of line'.
It is entered after characters of categories
1--4, 6--8, and 11--13, and after control symbols
other than control space.
An end-of-line character encountered in this state
results in a space token.

%%% \input figflow \message{left align flow diagram}
%%% \vskip12pt plus 1pt minus 4pt\relax %before spoint skip
%%% \begin{tdisp}%\PopIndentLevel
%%% \leavevmode\relax
%%% %\figmouth
%%% \message{fig mouth missing}
%%% \end{tdisp}
%% \input figflow \message{left align flow diagram}
%% \vskip12pt plus 1pt minus 4pt\relax %before spoint skip
%% \begin{tdisp}%\PopIndentLevel
%% \leavevmode\relax
%% %\figmouth
%% \message{fig mouth missing}
%% \end{tdisp}

%\input figs1
%\begin{quotation}
%  \figmouth
%\end{quotation}
\input figs1
\begin{quotation}
  \figmouth
\end{quotation}

%%\point[hathat] Accessing the full character set
%\section{Accessing the full character set}
%\label{hathat}
%\point[hathat] Accessing the full character set
\section{Accessing the full character set}
\label{hathat}

%Strictly speaking, \TeX's input processor
%is not a finite state automaton.
%This is because during the scanning of the input line
%all trios consisting of two {\sl equal\/} superscript characters 
%\index{\char94\char94\ replacement}
%(category code~7\index{category!7}) and a subsequent character
%(with character code~$<128$)
%are replaced by a single character with a character
%code in the range 0--127,
%differing by 64 from that of the original character.
Strictly speaking, \TeX's input processor
is not a finite state automaton.
This is because during the scanning of the input line
all trios consisting of two {\sl equal\/} superscript characters 
\index{\char94\char94\ replacement}
(category code~7\index{category!7}) and a subsequent character
(with character code~$<128$)
are replaced by a single character with a character
code in the range 0--127,
differing by 64 from that of the original character.

%This mechanism can be used, for instance, to access positions in a font
%corresponding to character codes that cannot
%be input, for instance because they are \ascii{} control characters.
%The most obvious examples are the \ascii{} \gr{return}
%and \gr{delete} characters; the corresponding 
%positions 13 and 127 in a font are
%accessible as \verb>^^M> and~\verb>^^?>.
%However, since the category of \verb>^^?> is 15\index{category!15}, invalid,
%that has to be changed before character 127 can be accessed.
This mechanism can be used, for instance, to access positions in a font
corresponding to character codes that cannot
be input, for instance because they are \ascii{} control characters.
The most obvious examples are the \ascii{} \gr{return}
and \gr{delete} characters; the corresponding 
positions 13 and 127 in a font are
accessible as \verb>^^M> and~\verb>^^?>.
However, since the category of \verb>^^?> is 15\index{category!15}, invalid,
that has to be changed before character 127 can be accessed.

%In \TeX3 this mechanism has been 
%modified and extended to access 256 characters:
%any quadruplet \verb-^^xy- where both \n x and \n y are lowercase
%hexadecimal digits \n0--\n9, \n a--\n f, 
%is replaced by a character in the
%range 0--255, namely the character the number of which is
%represented hexadecimally as~\n{xy}.
%This imposes a slight restriction on the applicability
%of the earlier mechanism: if, for instance, \verb>^^a>
%is typed to produce character~33, then a following
%\n0--\n9, \n{a}--\n{f} will be misunderstood.
In \TeX3 this mechanism has been 
modified and extended to access 256 characters:
any quadruplet \verb-^^xy- where both \n x and \n y are lowercase
hexadecimal digits \n0--\n9, \n a--\n f, 
is replaced by a character in the
range 0--255, namely the character the number of which is
represented hexadecimally as~\n{xy}.
This imposes a slight restriction on the applicability
of the earlier mechanism: if, for instance, \verb>^^a>
is typed to produce character~33, then a following
\n0--\n9, \n{a}--\n{f} will be misunderstood.

%While this process makes \TeX's input processor
%somewhat more powerful
%than a true finite state automaton,
%it does not interfere with the rest of
%the scanning. Therefore it is conceptually simpler to pretend that
%such a replacement of triplets or quadruplets
%of characters, starting with~\verb>^^>, is performed in advance. 
%In actual practice this is not possible,
%because an
%input line may assign category code~7\index{category!7} to some 
%character other than the circumflex, thereby 
%influencing its further processing.
While this process makes \TeX's input processor
somewhat more powerful
than a true finite state automaton,
it does not interfere with the rest of
the scanning. Therefore it is conceptually simpler to pretend that
such a replacement of triplets or quadruplets
of characters, starting with~\verb>^^>, is performed in advance. 
In actual practice this is not possible,
because an
input line may assign category code~7\index{category!7} to some 
character other than the circumflex, thereby 
influencing its further processing.


%%\point Transitions between internal states
%\section{Transitions between internal states}
%\point Transitions between internal states
\section{Transitions between internal states}

%Let us now discuss the effects on the internal state
%of \TeX's input processor when
%certain category codes are encountered in the input. 
Let us now discuss the effects on the internal state
of \TeX's input processor when
certain category codes are encountered in the input. 

%%\spoint 0: escape character
%\subsection{0: escape character}
%\index{escape!character|see{character, escape}}
%\spoint 0: escape character
\subsection{0: escape character}
\index{escape!character|see{character, escape}}

%When an \indextermbus{escape}{character} is encountered,
%\TeX\ starts forming a control sequence token.
%Three different types of control sequence can result,
%depending on the category code of the character that
%follows the escape character.
When an \indextermbus{escape}{character} is encountered,
\TeX\ starts forming a control sequence token.
Three different types of control sequence can result,
depending on the category code of the character that
follows the escape character.

%\begin{itemize}\item
%If the character following the escape is of category~11\index{category!11},
%letter, then \TeX\ combines the escape,
%that character and all following
%characters of category~11, into a control word.
%After that \TeX\
%goes into state~{\italic S}, skipping spaces.
%\item
%With a character of category~10\index{category!10}, space, a control
%symbol called control space results, and \TeX\ goes into
%state~{\italic S}.
%\item
%With a character of any other category code 
%a control symbol results, and \TeX\ goes into state~{\italic M},
%middle of line.
%\end{itemize}
\begin{itemize}\item
If the character following the escape is of category~11\index{category!11},
letter, then \TeX\ combines the escape,
that character and all following
characters of category~11, into a control word.
After that \TeX\
goes into state~{\italic S}, skipping spaces.
\item
With a character of category~10\index{category!10}, space, a control
symbol called control space results, and \TeX\ goes into
state~{\italic S}.
\item
With a character of any other category code 
a control symbol results, and \TeX\ goes into state~{\italic M},
middle of line.
\end{itemize}

%The letters of a control sequence name have to be all on one line;
%a control sequence name is not continued on the next line
%if the current line ends with a comment sign, or if (by letting
%\cs{endlinechar} be outside the range~0--255) 
%there is no terminating character.
The letters of a control sequence name have to be all on one line;
a control sequence name is not continued on the next line
if the current line ends with a comment sign, or if (by letting
\cs{endlinechar} be outside the range~0--255) 
there is no terminating character.

%%\spoint 1--4, 7--8, 11--13: non-blank characters
%\subsection{1--4, 7--8, 11--13: non-blank characters}
%\spoint 1--4, 7--8, 11--13: non-blank characters
\subsection{1--4, 7--8, 11--13: non-blank characters}

%Characters of category codes 1--4, 7--8, and 11--13 are made
%into tokens, and \TeX\ goes into state~{\italic M}.
Characters of category codes 1--4, 7--8, and 11--13 are made
into tokens, and \TeX\ goes into state~{\italic M}.

%%\spoint 5: end of line
%\subsection{5: end of line}
%\spoint 5: end of line
\subsection{5: end of line}

%Upon encountering an end-of-line character, 
%\TeX\ discards the rest of the
%line, and starts processing the next line,
%in state~{\italic N}. If the current state was~{\italic N},
%that is, if the
%line so far contained at most spaces, a~\cs{par} token
%is inserted; if the state was~{\italic M}, a~space token is inserted,
%and in state~{\italic S} nothing is inserted.
Upon encountering an end-of-line character, 
\TeX\ discards the rest of the
line, and starts processing the next line,
in state~{\italic N}. If the current state was~{\italic N},
that is, if the
line so far contained at most spaces, a~\cs{par} token
is inserted; if the state was~{\italic M}, a~space token is inserted,
and in state~{\italic S} nothing is inserted.

%Note that by `end-of-line character' a character with category
%code~5 is meant. This is not necessarily the \cs{endlinechar},
%nor need it appear at the end of the line.
%See below for further remarks on line ends.
Note that by `end-of-line character' a character with category
code~5 is meant. This is not necessarily the \cs{endlinechar},
nor need it appear at the end of the line.
See below for further remarks on line ends.

%%\spoint 6: parameter
%\subsection{6: parameter}
%\spoint 6: parameter
\subsection{6: parameter}

%A \indextermbus{parameter}{character} \ldash usually~\verb=#= \rdash  can be
%followed by either a digit \n{1..9} 
%in the context of macro definitions
%\altt
%or by another parameter character. 
%In the first case a `parameter token' results,
%in the second case only a single parameter character
%is passed on as a character token for further processing.
%In either case \TeX\ goes into state~{\italic M}.
A \indextermbus{parameter}{character} \ldash usually~\verb=#= \rdash  can be
followed by either a digit \n{1..9} 
in the context of macro definitions
\altt
or by another parameter character. 
In the first case a `parameter token' results,
in the second case only a single parameter character
is passed on as a character token for further processing.
In either case \TeX\ goes into state~{\italic M}.

%A parameter character can also appear on its own in an
%alignment preamble (see Chapter~\ref{align}).
A parameter character can also appear on its own in an
alignment preamble (see Chapter~\ref{align}).

%%\spoint 7: superscript
%\subsection{7: superscript}
%\spoint 7: superscript
\subsection{7: superscript}

%A superscript character is handled like most non-blank
%characters, except in the case where it is followed
%by a  superscript character of the same character code.
%The process
%that replaces these two characters plus the following character
%(possibly two characters in \TeX3) by another character
%was described above.
A superscript character is handled like most non-blank
characters, except in the case where it is followed
by a  superscript character of the same character code.
The process
that replaces these two characters plus the following character
(possibly two characters in \TeX3) by another character
was described above.

%%\spoint 9: ignored character
%\subsection{9: ignored character}
%\spoint 9: ignored character
\subsection{9: ignored character}

%Characters of category 9 are ignored; \TeX\ remains in the same state.
Characters of category 9 are ignored; \TeX\ remains in the same state.

%%\spoint 10: space
%\subsection{10: space}
%\spoint 10: space
\subsection{10: space}

%A token with category code 10 \ldash this is called a \gr{space token},
%irrespective of the character code \rdash 
%is ignored in states {\italic N} and~{\italic S} 
%(and the state does not change); 
%in state~{\italic M} \TeX\ goes into state~{\italic S}, inserting
%a token that has category~10 and character code~32 
%(\ascii{} space).
%This implies that the character code of the space token may change
%from the character that was actually input.
A token with category code 10 \ldash this is called a \gr{space token},
irrespective of the character code \rdash 
is ignored in states {\italic N} and~{\italic S} 
(and the state does not change); 
in state~{\italic M} \TeX\ goes into state~{\italic S}, inserting
a token that has category~10 and character code~32 
(\ascii{} space).
This implies that the character code of the space token may change
from the character that was actually input.

%%\spoint 14: comment
%\subsection{14: comment}
%\spoint 14: comment
\subsection{14: comment}

%A comment character causes \TeX\ to discard 
%the rest of the line, including the comment character.
%In particular, the end-of-line character is not seen,
%so even if the comment was encountered in state~{\italic M}, no space
%token is inserted.
A comment character causes \TeX\ to discard 
the rest of the line, including the comment character.
In particular, the end-of-line character is not seen,
so even if the comment was encountered in state~{\italic M}, no space
token is inserted.

%%\spoint 15: invalid
%\subsection{15: invalid}
%\spoint 15: invalid
\subsection{15: invalid}

%Invalid characters cause an error message. \TeX\ remains in
%the state it was in.
%However, in the context of a control symbol an invalid character
%is acceptable. Thus \verb>\^^?> does not cause any error messages.
Invalid characters cause an error message. \TeX\ remains in
the state it was in.
However, in the context of a control symbol an invalid character
is acceptable. Thus \verb>\^^?> does not cause any error messages.

%%\point[cat12] Letters and other characters
%\section{Letters and other characters}
%\label{cat12}
%\point[cat12] Letters and other characters
\section{Letters and other characters}
\label{cat12}

%In most programming languages identifiers can consist
%of both letters and digits (and possibly some other
%character such as the underscore), but control sequences in \TeX\
%are only allowed to be formed out of characters of category~11,
%letter. Ordinarily, the digits and punctuation symbols have
%category~12, other character.
%However, there are contexts where \TeX\ itself
%generates a string of characters, all of which have
%category code~12, even if that is not their usual
%category code.
In most programming languages identifiers can consist
of both letters and digits (and possibly some other
character such as the underscore), but control sequences in \TeX\
are only allowed to be formed out of characters of category~11,
letter. Ordinarily, the digits and punctuation symbols have
category~12, other character.
However, there are contexts where \TeX\ itself
generates a string of characters, all of which have
category code~12, even if that is not their usual
category code.

%This happens when the operations 
%\cs{string},
%\cs{number},
%\cs{romannumeral},
%\cs{jobname},
%\cs{fontname},
%\cs{meaning},
%and \cs{the}
%are used to generate a stream of character tokens.
%If any of the characters delivered by such a command
%is a space character (that is, character code~32), 
%it receives category code~10, space.
This happens when the operations 
\cs{string},
\cs{number},
\cs{romannumeral},
\cs{jobname},
\cs{fontname},
\cs{meaning},
and \cs{the}
are used to generate a stream of character tokens.
If any of the characters delivered by such a command
is a space character (that is, character code~32), 
it receives category code~10, space.

%For the extremely rare case where a hexadecimal digit has been
%hidden in a control sequence, \TeX\ allows \n A$_{12}$--\n F$_{12}$
%to be hexadecimal digits, in addition to the ordinary
%\n A$_{11}$--\n F$_{11}$ (here
%the subscripts denote the category codes).
For the extremely rare case where a hexadecimal digit has been
hidden in a control sequence, \TeX\ allows \n A$_{12}$--\n F$_{12}$
to be hexadecimal digits, in addition to the ordinary
\n A$_{11}$--\n F$_{11}$ (here
the subscripts denote the category codes).

%For example,
%\begin{disp}\verb>\string\end>\quad gives four character tokens\quad
%\n{\char92$_{12}$e$_{12}$n$_{12}$d$_{12}$} \end{disp}
%Note that the \indextermbus{escape}{character}~\texttt{\char`\\}$_{12}$\label{use:escape}
%is used in the output only because the
%value of \cs{escapechar} is the character code for the
%backslash. Another value of \cs{escapechar} leads to another
%character in the output of \cs{string}. 
%The \cs{string} command is treated further in Chapter~\ref{char}.
For example,
\begin{disp}\verb>\string\end>\quad gives four character tokens\quad
\n{\char92$_{12}$e$_{12}$n$_{12}$d$_{12}$} \end{disp}
Note that the \indextermbus{escape}{character}~\texttt{\char`\\}$_{12}$\label{use:escape}
is used in the output only because the
value of \cs{escapechar} is the character code for the
backslash. Another value of \cs{escapechar} leads to another
character in the output of \cs{string}. 
The \cs{string} command is treated further in Chapter~\ref{char}.

%Spaces can wind up in control sequences:
%\begin{disp}\verb>\csname a b\endcsname>\end{disp} gives a control sequence
%token in which one of the three characters is a space.
%Turning this control sequence token into a string of characters
%\begin{disp}\verb>\expandafter\string\csname a b\endcsname>\end{disp}
%gives \n{\char92$_{12}$a$_{12}$\char32$_{10}$b$_{12}$}.
Spaces can wind up in control sequences:
\begin{disp}\verb>\csname a b\endcsname>\end{disp} gives a control sequence
token in which one of the three characters is a space.
Turning this control sequence token into a string of characters
\begin{disp}\verb>\expandafter\string\csname a b\endcsname>\end{disp}
gives \n{\char92$_{12}$a$_{12}$\char32$_{10}$b$_{12}$}.


%As a more practical example, suppose there exists a sequence
%of input files \n{file1.tex}, \n{file2.tex}\label{ex:jobnumber},
%and we want to
%write a macro that finds the number of the input file
%that is being processed. One approach would be to write
%\begin{verbatim}
%\newcount\filenumber  \def\getfilenumber file#1.{\filenumber=#1 }
%\expandafter\getfilenumber\jobname.
%\end{verbatim}
%where the letters \n{file} in the parameter text of the
%macro (see Section~\ref{param:text}) absorb that part of the
%jobname, leaving the number as the sole parameter.
As a more practical example, suppose there exists a sequence
of input files \n{file1.tex}, \n{file2.tex}\label{ex:jobnumber},
and we want to
write a macro that finds the number of the input file
that is being processed. One approach would be to write
\begin{verbatim}
\newcount\filenumber  \def\getfilenumber file#1.{\filenumber=#1 }
\expandafter\getfilenumber\jobname.
\end{verbatim}
where the letters \n{file} in the parameter text of the
macro (see Section~\ref{param:text}) absorb that part of the
jobname, leaving the number as the sole parameter.

%However, this is slightly incorrect: the letters \n{file} resulting
%from the \cs{jobname} command have category code~12, instead of
%11 for the ones in the definition of \cs{getfilenumber}.
%This can be repaired as follows:
%\begin{verbatim}
%{\escapechar=-1
% \expandafter\gdef\expandafter\getfilenumber
%       \string\file#1.{\filenumber=#1 }
%}
%\end{verbatim}
%Now the sequence \verb>\string\file> gives the four
%letters \n{f$_{12}$i$_{12}$l$_{12}$e$_{12}$}; 
%the \cs{expandafter} commands let this be executed prior to
%the macro definition;
%the backslash is omitted because we put\handbreak \verb>\escapechar=-1>.
%Confining this value to a group makes it necessary to use~\cs{gdef}.
However, this is slightly incorrect: the letters \n{file} resulting
from the \cs{jobname} command have category code~12, instead of
11 for the ones in the definition of \cs{getfilenumber}.
This can be repaired as follows:
\begin{verbatim}
{\escapechar=-1
 \expandafter\gdef\expandafter\getfilenumber
       \string\file#1.{\filenumber=#1 }
}
\end{verbatim}
Now the sequence \verb>\string\file> gives the four
letters \n{f$_{12}$i$_{12}$l$_{12}$e$_{12}$}; 
the \cs{expandafter} commands let this be executed prior to
the macro definition;
the backslash is omitted because we put\handbreak \verb>\escapechar=-1>.
Confining this value to a group makes it necessary to use~\cs{gdef}.


%\section{The \lowercase{\n{\char92par}} token}
\section{The \lowercase{\n{\char92par}} token}

%\TeX\ inserts a \csterm par\par\ token into the input after
%an \indextermbus{empty}{line}, that is, when 
%encountering a character with category code~5,
%end of line, in state~{\italic N}.
%It is good to realize when exactly this happens:
%since \TeX\ leaves state~{\italic N}
%when it encounters any token but a space,
%a~line giving a \cs{par} can only contain characters
%of category~10. In particular, it cannot end with a comment
%character. Quite often this fact is used the other way around:
%if an empty line is wanted for the layout of the input
%one can put a comment sign on that line.
\TeX\ inserts a \csterm par\par\ token into the input after
an \indextermbus{empty}{line}, that is, when 
encountering a character with category code~5,
end of line, in state~{\italic N}.
It is good to realize when exactly this happens:
since \TeX\ leaves state~{\italic N}
when it encounters any token but a space,
a~line giving a \cs{par} can only contain characters
of category~10. In particular, it cannot end with a comment
character. Quite often this fact is used the other way around:
if an empty line is wanted for the layout of the input
one can put a comment sign on that line.


%Two consecutive empty lines generate two \cs{par} tokens.
%For all practical purposes this is equivalent to one \cs{par},
%because after the first one \TeX\ enters vertical mode, and
%in vertical mode a \cs{par} only
%exercises the page builder,
%and clears the paragraph shape parameters.
Two consecutive empty lines generate two \cs{par} tokens.
For all practical purposes this is equivalent to one \cs{par},
because after the first one \TeX\ enters vertical mode, and
in vertical mode a \cs{par} only
exercises the page builder,
and clears the paragraph shape parameters.

%A \cs{par} is also inserted into the input when \TeX\ sees a
%\gram{vertical command} in unrestricted horizontal mode.
%After the \cs{par} has been read and expanded, the
%vertical command is examined anew (see Chapters~\ref{hvmode}
%and~\ref{par:end}).
A \cs{par} is also inserted into the input when \TeX\ sees a
\gram{vertical command} in unrestricted horizontal mode.
After the \cs{par} has been read and expanded, the
vertical command is examined anew (see Chapters~\ref{hvmode}
and~\ref{par:end}).

%The \cs{par} token may also be inserted by the \cs{end}
%command that finishes off the run of \TeX; see Chapter~\ref{output}.
The \cs{par} token may also be inserted by the \cs{end}
command that finishes off the run of \TeX; see Chapter~\ref{output}.

%It is important to realize that \TeX\ does what it normally does
%when encountering an empty line
%(which is ending a paragraph)
%only because of the default definition of the \cs{par} token.
%By redefining \cs{par} the behaviour
%caused by empty lines and vertical commands can be changed completely,
%and  interesting special effects can be achieved.
%In order to continue to be able  to cause the actions normally
%associated with \cs{par}, the synonym \cs{endgraf} is
%available in the plain format. See further Chapter~\ref{par:end}.
It is important to realize that \TeX\ does what it normally does
when encountering an empty line
(which is ending a paragraph)
only because of the default definition of the \cs{par} token.
By redefining \cs{par} the behaviour
caused by empty lines and vertical commands can be changed completely,
and  interesting special effects can be achieved.
In order to continue to be able  to cause the actions normally
associated with \cs{par}, the synonym \cs{endgraf} is
available in the plain format. See further Chapter~\ref{par:end}.

%The \cs{par} token is not allowed to be part of a macro
%argument, unless the macro has been declared to be \cs{long}.
%A \cs{par} in the argument of a non-\cs{long} macro
%prompts \TeX\ to give a `runaway argument' message.
%Control sequences that have been \cs{let} to \cs{par}
%(such as \cs{endgraf}) are allowed, however.
The \cs{par} token is not allowed to be part of a macro
argument, unless the macro has been declared to be \cs{long}.
A \cs{par} in the argument of a non-\cs{long} macro
prompts \TeX\ to give a `runaway argument' message.
Control sequences that have been \cs{let} to \cs{par}
(such as \cs{endgraf}) are allowed, however.

%\section{Spaces}
\section{Spaces}

%This section treats some of the aspects of the
%\indextermbus{space}{character} and \indextermbus{space}{token} in the
%initial processing stages of \TeX. The topic of spacing in text
%typesetting is treated in Chapter~\ref{space}.
This section treats some of the aspects of the
\indextermbus{space}{character} and \indextermbus{space}{token} in the
initial processing stages of \TeX. The topic of spacing in text
typesetting is treated in Chapter~\ref{space}.


%\subsection{Skipped spaces}
\subsection{Skipped spaces}

%From the discussion of the internal states of \TeX's 
%input processor
%it is clear that some spaces in the input never reach the
%output; in fact they never get past the input processor.
%These are for instance the spaces at the beginning
%of an input line, and the spaces following the one
%that lets \TeX\ switch to state~{\italic S}.
From the discussion of the internal states of \TeX's 
input processor
it is clear that some spaces in the input never reach the
output; in fact they never get past the input processor.
These are for instance the spaces at the beginning
of an input line, and the spaces following the one
that lets \TeX\ switch to state~{\italic S}.


%On the other hand, line ends can generate spaces (which are not
%in the input) that may wind up in the output.
%There is a third kind of space: the spaces that get past the
%input processor,
%or are even generated there, but still do not wind up in the
%output. These are the \gram{optional spaces} that the 
%syntax of \TeX\ allows in various places.
On the other hand, line ends can generate spaces (which are not
in the input) that may wind up in the output.
There is a third kind of space: the spaces that get past the
input processor,
or are even generated there, but still do not wind up in the
output. These are the \gram{optional spaces} that the 
syntax of \TeX\ allows in various places.

%%\spoint Optional spaces
%\subsection{Optional spaces}
%\spoint Optional spaces
\subsection{Optional spaces}

%The syntax of \TeX\ has the concepts of \indextermbus{optional}{spaces}
%and `one optional space':
%\begin{disp}\gr{one optional space} $\longrightarrow$
%\gr{space token} $|$ \gr{empty}\nl
%\gr{optional spaces} $\longrightarrow$
%\gr{empty} $|$ \gr{space token}\gr{optional spaces}\end{disp}
%In general, \gr{one optional space} is allowed after
%numbers and glue specifications, while \gr{optional spaces} are
%allowed whenever a space can occur inside a number
%(for example, between a minus sign and the digits of the number)
%or glue specification (for example, between \n{plus} and \n{1fil}).
%Also, the definition of \gr{equals} allows \gr{optional spaces}
%before the \n= sign.
The syntax of \TeX\ has the concepts of \indextermbus{optional}{spaces}
and `one optional space':
\begin{disp}\gr{one optional space} $\longrightarrow$
\gr{space token} $|$ \gr{empty}\nl
\gr{optional spaces} $\longrightarrow$
\gr{empty} $|$ \gr{space token}\gr{optional spaces}\end{disp}
In general, \gr{one optional space} is allowed after
numbers and glue specifications, while \gr{optional spaces} are
allowed whenever a space can occur inside a number
(for example, between a minus sign and the digits of the number)
or glue specification (for example, between \n{plus} and \n{1fil}).
Also, the definition of \gr{equals} allows \gr{optional spaces}
before the \n= sign.

%Here are some examples of optional spaces.
Here are some examples of optional spaces.

%\begin{itemize} 
%\item A number can be delimited by \gr{one optional space}. 
%This prevents accidents (see Chapter~\ref{number}), 
%and it speeds up processing, as \TeX\ can 
%detect more easily where the \gram{number} being read ends.
%Note, however, that not every `number' is a \gram{number}:
%for instance the {\tt 2} in \cs{magstep2} is not a number,
%but the  single token that is the parameter of the
%\cs{magstep} macro. Thus a space or line end after this
%is significant. Another example is a parameter number,
%for example~\n{\#1}: since at most nine parameters are allowed, scanning
%one digit after the parameter character suffices.
\begin{itemize} 
\item A number can be delimited by \gr{one optional space}. 
This prevents accidents (see Chapter~\ref{number}), 
and it speeds up processing, as \TeX\ can 
detect more easily where the \gram{number} being read ends.
Note, however, that not every `number' is a \gram{number}:
for instance the {\tt 2} in \cs{magstep2} is not a number,
but the  single token that is the parameter of the
\cs{magstep} macro. Thus a space or line end after this
is significant. Another example is a parameter number,
for example~\n{\#1}: since at most nine parameters are allowed, scanning
one digit after the parameter character suffices.

%\item From the grammar of \TeX\ 
%it follows that the
%keywords \n{fill} and \n{filll}
%consist of \n{fil} and
%separate {\tt l}$\,$s, each of which is a keyword
%(see page~\pageref{keywords} for a more elaborate discussion),
%and hence can be followed by optional spaces. 
%Therefore forms such as \hbox{\n{fil L l}} are also valid.
%This is a potential source of strange accidents.
%In most cases, appending a \cs{relax} token prevents
%such mishaps.
\item From the grammar of \TeX\ 
it follows that the
keywords \n{fill} and \n{filll}
consist of \n{fil} and
separate {\tt l}$\,$s, each of which is a keyword
(see page~\pageref{keywords} for a more elaborate discussion),
and hence can be followed by optional spaces. 
Therefore forms such as \hbox{\n{fil L l}} are also valid.
This is a potential source of strange accidents.
In most cases, appending a \cs{relax} token prevents
such mishaps.

%\item The primitive command \csterm ignorespaces\par\ 
%may come in handy as the final command in a macro definition.
%As it gobbles up
%optional spaces, it can be used to prevent spaces following the
%closing brace of an argument from winding up in the output
%inadvertently. For example, in
%\begin{verbatim}
%\def\item#1{\par\leavevmode
%    \llap{#1\enspace}\ignorespaces}
%\item{a/}one line \item{b/} another line \item{c/}
%yet another
%\end{verbatim} 
%the \cs{ignorespaces} prevents spurious
%spaces in the second and third item.
%An empty line
%after \cs{ignorespaces} will still insert a \cs{par}, however.
%\end{itemize}
\item The primitive command \csterm ignorespaces\par\ 
may come in handy as the final command in a macro definition.
As it gobbles up
optional spaces, it can be used to prevent spaces following the
closing brace of an argument from winding up in the output
inadvertently. For example, in
\begin{verbatim}
\def\item#1{\par\leavevmode
    \llap{#1\enspace}\ignorespaces}
\item{a/}one line \item{b/} another line \item{c/}
yet another
\end{verbatim} 
the \cs{ignorespaces} prevents spurious
spaces in the second and third item.
An empty line
after \cs{ignorespaces} will still insert a \cs{par}, however.
\end{itemize}

%%\spoint Ignored and obeyed spaces
%\subsection{Ignored and obeyed spaces}
%\spoint Ignored and obeyed spaces
\subsection{Ignored and obeyed spaces}

%After control words spaces are ignored. This is not an
%instance of optional spaces, but it is due to the fact that
%\TeX\ goes into state~{\italic S}, skipping spaces, after control
%words. Similarly an end-of-line character is skipped
%after a control word.
After control words spaces are ignored. This is not an
instance of optional spaces, but it is due to the fact that
\TeX\ goes into state~{\italic S}, skipping spaces, after control
words. Similarly an end-of-line character is skipped
after a control word.

%Numbers are delimited by only \gr{one optional space},
%but still
%\begin{disp}\n{a\char92 count0=3\char32\char32b}\quad gives\quad `ab',\end{disp}
%because \TeX\ goes into state~{\italic S} after the first
%space token. The second space is therefore skipped 
%in the input processor of \TeX; it never becomes a space token.
Numbers are delimited by only \gr{one optional space},
but still
\begin{disp}\n{a\char92 count0=3\char32\char32b}\quad gives\quad `ab',\end{disp}
because \TeX\ goes into state~{\italic S} after the first
space token. The second space is therefore skipped 
in the input processor of \TeX; it never becomes a space token.

%Spaces are skipped furthermore when \TeX\ is in state~{\italic N},
%newline. When \TeX\ is processing in vertical mode
%space tokens (that is, spaces that were not skipped)
%are ignored. For example, the space inserted (because of the line end)
%after the first box in
%\begin{verbatim}
%\par
%\hbox{a}
%\hbox{b}
%\end{verbatim}
%has no effect.
Spaces are skipped furthermore when \TeX\ is in state~{\italic N},
newline. When \TeX\ is processing in vertical mode
space tokens (that is, spaces that were not skipped)
are ignored. For example, the space inserted (because of the line end)
after the first box in
\begin{verbatim}
\par
\hbox{a}
\hbox{b}
\end{verbatim}
has no effect.

%Both plain \TeX\ and \LaTeX\ define a command \cs{obeyspaces}
%\altt
%that makes spaces significant: after one space other spaces are no
%longer ignored. In both cases the basis is
%\altt
%\begin{verbatim}
%\catcode`\ =13 \def {\space}
%\end{verbatim}
%However, there is a difference between the two cases:
%in plain \TeX\ \begin{verbatim}
%\def\space{ }
%\end{verbatim}
%while in \LaTeX\ \begin{verbatim}
%\def\space{\leavevmode{} }
%\end{verbatim}
%although the macros bear other names there.
Both plain \TeX\ and \LaTeX\ define a command \cs{obeyspaces}
\altt
that makes spaces significant: after one space other spaces are no
longer ignored. In both cases the basis is
\altt
\begin{verbatim}
\catcode`\ =13 \def {\space}
\end{verbatim}
However, there is a difference between the two cases:
in plain \TeX\ \begin{verbatim}
\def\space{ }
\end{verbatim}
while in \LaTeX\ \begin{verbatim}
\def\space{\leavevmode{} }
\end{verbatim}
although the macros bear other names there.

%The difference between the two macros becomes
%apparent in the context of \cs{obeylines}:
%each line end is then a \cs{par} command, implying that
%each next line is started in vertical mode.
%An active space is expanded by the plain macro to a space token, 
%which is ignored in vertical mode.
%The active spaces in \LaTeX\ will immediately switch to horizontal
%mode, so that each space is significant.
The difference between the two macros becomes
apparent in the context of \cs{obeylines}:
each line end is then a \cs{par} command, implying that
each next line is started in vertical mode.
An active space is expanded by the plain macro to a space token, 
which is ignored in vertical mode.
The active spaces in \LaTeX\ will immediately switch to horizontal
mode, so that each space is significant.

%\subsection{More ignored spaces}
\subsection{More ignored spaces}

%There are three further places where \TeX\ will ignore space tokens.
%\alt
%\begin{enumerate}
%\item When \TeX\ is looking for
%an undelimited macro argument it will accept the
%first token (or group) that is not a space. This is treated
%in Chapter~\ref{macro}.
There are three further places where \TeX\ will ignore space tokens.
\alt
\begin{enumerate}
\item When \TeX\ is looking for
an undelimited macro argument it will accept the
first token (or group) that is not a space. This is treated
in Chapter~\ref{macro}.

%\item In math mode space tokens are ignored (see Chapter~\ref{math}).
\item In math mode space tokens are ignored (see Chapter~\ref{math}).

%\item After an alignment tab character spaces are ignored
%(see Chapter~\ref{align}).
%\end{enumerate}
\item After an alignment tab character spaces are ignored
(see Chapter~\ref{align}).
\end{enumerate}

%\subsection{\gr{space token}}
\subsection{\gr{space token}}

%Spaces are anomalous in \TeX.
%For instance, the \cs{string} operation 
%assigns category code~12\index{category!12} to all
%characters except spaces; they receive category~10\index{category!10}.
%Also, as was said above, \TeX's input processor converts (when in
%state~{\italic M}) all tokens with category code~10 into real spaces:
%they get character code~32.
%Any character token with category~10 is called
%\gram{space token}\indexterm{space! token}.
%Space tokens with character
%code not equal to 32 are called \indextermbus{funny}{spaces}.
Spaces are anomalous in \TeX.
For instance, the \cs{string} operation 
assigns category code~12\index{category!12} to all
characters except spaces; they receive category~10\index{category!10}.
Also, as was said above, \TeX's input processor converts (when in
state~{\italic M}) all tokens with category code~10 into real spaces:
they get character code~32.
Any character token with category~10 is called
\gram{space token}\indexterm{space! token}.
Space tokens with character
code not equal to 32 are called \indextermbus{funny}{spaces}.

%\begin{example} After giving the character \n Q 
%the category code of a space character, 
%and using it in a definition
%\begin{verbatim}
%\catcode`Q=10 \def\q{aQb}
%\end{verbatim}
%we get
%\begin{verbatim}
%\show\q
%macro:-> a b
%\end{verbatim}
%because the input processor
%changes the character code of the funny space
%in the definition.
%\end{example}
\begin{example} After giving the character \n Q 
the category code of a space character, 
and using it in a definition
\begin{verbatim}
\catcode`Q=10 \def\q{aQb}
\end{verbatim}
we get
\begin{verbatim}
\show\q
macro:-> a b
\end{verbatim}
because the input processor
changes the character code of the funny space
in the definition.
\end{example}

%Space tokens with character codes other than 32 can be
%created using, for instance, \cs{uppercase}.
%However, `since the various forms of
%space tokens are almost identical in behaviour, there's no
%point dwelling on the details'; see~\cite{Knuth:TeXbook}~p.~377.
Space tokens with character codes other than 32 can be
created using, for instance, \cs{uppercase}.
However, `since the various forms of
space tokens are almost identical in behaviour, there's no
point dwelling on the details'; see~\cite{Knuth:TeXbook}~p.~377.


%%\spoint Control space
%\subsection{Control space}
%\spoint Control space
\subsection{Control space}

%The `control space' command \verb-\-\n{\char32}
%\cstoidx\char32\par\
%contributes the amount of space that a \gr{space token} would
%when the \verb=\spacefactor= is~1000.
%A~control space
%is not treated like a space token, or like a macro
%expanding to one (which is how \cs{space} is defined in plain \TeX).
%For instance, \TeX\ ignores spaces
%at the beginning of an input line, but
%control space is a \gr{horizontal command}, so it 
%makes \TeX\ switch from vertical to horizontal mode
%(and insert an indentation box).
%See  Chapter~\ref{space} for the space factor, and
%chapter~\ref{hvmode} for horizontal and vertical modes.
The `control space' command \verb-\-\n{\char32}
\cstoidx\char32\par\
contributes the amount of space that a \gr{space token} would
when the \verb=\spacefactor= is~1000.
A~control space
is not treated like a space token, or like a macro
expanding to one (which is how \cs{space} is defined in plain \TeX).
For instance, \TeX\ ignores spaces
at the beginning of an input line, but
control space is a \gr{horizontal command}, so it 
makes \TeX\ switch from vertical to horizontal mode
(and insert an indentation box).
See  Chapter~\ref{space} for the space factor, and
chapter~\ref{hvmode} for horizontal and vertical modes.

%%\spoint `\n{\char32}'
%\subsection{`\n{\char32}'}
%\spoint `\n{\char32}'
\subsection{`\n{\char32}'}

%The explicit symbol `\n{\char32}' for a space
%is character~32 in the Computer Modern typewriter typeface.
%However, switching to \cs{tt} is not sufficient to get
%spaces denoted this way, because spaces will still
%receive special treatment in the input processor.
The explicit symbol `\n{\char32}' for a space
is character~32 in the Computer Modern typewriter typeface.
However, switching to \cs{tt} is not sufficient to get
spaces denoted this way, because spaces will still
receive special treatment in the input processor.

%One way to
%let spaces be typeset by \n{\char32}
%is to set
%\begin{verbatim}
%\catcode`\ =12
%\end{verbatim}
%\TeX\ will then take a space as the instruction to
%typeset character number~32. Moreover, subsequent spaces
%are not skipped, but also typeset this way: state~{\italic S}
%is only entered after a character with category code~10.
%Similarly, spaces after a control sequence are made
%visible by changing the category code of the space character.
One way to
let spaces be typeset by \n{\char32}
is to set
\begin{verbatim}
\catcode`\ =12
\end{verbatim}
\TeX\ will then take a space as the instruction to
typeset character number~32. Moreover, subsequent spaces
are not skipped, but also typeset this way: state~{\italic S}
is only entered after a character with category code~10.
Similarly, spaces after a control sequence are made
visible by changing the category code of the space character.

%\section{More about line ends}
\section{More about line ends}

%\TeX\ accepts lines from an input file, excluding any line
%terminator that may be used.
%Because of this, \TeX's behaviour here is not dependent
%on the operating system and the \indextermsub{line}{terminator}
%it uses (\key{CR}-\key{LF},
%\key{LF}, or none at all for block storage).
%From the input line any trailing spaces are removed.
%The reason for this is historic; it has to do with 
%the block storage mode on \key{IBM} mainframe computers.
%For some computer-specific problems with end-of-line
%characters, see~\cite{B:ctrl-M}.
\TeX\ accepts lines from an input file, excluding any line
terminator that may be used.
Because of this, \TeX's behaviour here is not dependent
on the operating system and the \indextermsub{line}{terminator}
it uses (\key{CR}-\key{LF},
\key{LF}, or none at all for block storage).
From the input line any trailing spaces are removed.
The reason for this is historic; it has to do with 
the block storage mode on \key{IBM} mainframe computers.
For some computer-specific problems with end-of-line
characters, see~\cite{B:ctrl-M}.

%A~terminator character is then appended
%with a character code of \cs{endlinechar}, 
%unless this parameter has a value that
%is negative or more than~255. 
%Note that this terminator character
%need not have category code~5\index{category!5}, end of line.
A~terminator character is then appended
with a character code of \cs{endlinechar}, 
unless this parameter has a value that
is negative or more than~255. 
Note that this terminator character
need not have category code~5\index{category!5}, end of line.

%\subsection{Obeylines}
\subsection{Obeylines}

%Every once in a while it is desirable that the line ends in
%\message{Check spurious space obeylines+1}%
%\cstoidx obeylines\par\howto Change the meaning of the line end\par
%the input correspond to those in the output.
%The following piece of code does the trick:
%\begin{verbatim}
%\catcode`\^^M=13 %
%\def^^M{\par}% 
%\end{verbatim}
%The \cs{endlinechar} character is here made active,
%and its meaning becomes \cs{par}.
%The comment signs prevent \TeX\ from seeing the terminator of the
%\alt
%lines of this definition, and expanding it since it is active.
Every once in a while it is desirable that the line ends in
\message{Check spurious space obeylines+1}%
\cstoidx obeylines\par\howto Change the meaning of the line end\par
the input correspond to those in the output.
The following piece of code does the trick:
\begin{verbatim}
\catcode`\^^M=13 %
\def^^M{\par}% 
\end{verbatim}
The \cs{endlinechar} character is here made active,
and its meaning becomes \cs{par}.
The comment signs prevent \TeX\ from seeing the terminator of the
\alt
lines of this definition, and expanding it since it is active.

%However, it takes some care to embed this code in a macro.
%The definition
%\begin{verbatim}
%\def\obeylines{\catcode`\^^M=13 \def^^M{\par}}
%\end{verbatim}
%will be misunderstood:
%\TeX\ will discard everything
%after the second \verb>^^M>, because this has category code~5.
%Effectively, this line is then
%\begin{verbatim}
%\def\obeylines{\catcode`\^^M=13 \def
%\end{verbatim}
%To remedy this,
%the definition itself has to be
%performed in a context where \verb>^^M> is an active
%character:
%\begin{verbatim}
%{\catcode`\^^M=13 %
% \gdef\obeylines{\catcode`\^^M=13 \def^^M{\par}}%
%}
%\end{verbatim}
%Empty lines in the  input are not taken into account
%in this definition: these disappear, because two consecutive \cs{par}
%tokens are (in this case) equivalent to one. 
%A slightly modified definition for the line end as
%\begin{verbatim}
%\def^^M{\par\leavevmode}
%\end{verbatim}
%remedies this:
%now every line end forces \TeX\ to start a paragraph. For empty
%lines this will then be an empty paragraph.
However, it takes some care to embed this code in a macro.
The definition
\begin{verbatim}
\def\obeylines{\catcode`\^^M=13 \def^^M{\par}}
\end{verbatim}
will be misunderstood:
\TeX\ will discard everything
after the second \verb>^^M>, because this has category code~5.
Effectively, this line is then
\begin{verbatim}
\def\obeylines{\catcode`\^^M=13 \def
\end{verbatim}
To remedy this,
the definition itself has to be
performed in a context where \verb>^^M> is an active
character:
\begin{verbatim}
{\catcode`\^^M=13 %
 \gdef\obeylines{\catcode`\^^M=13 \def^^M{\par}}%
}
\end{verbatim}
Empty lines in the  input are not taken into account
in this definition: these disappear, because two consecutive \cs{par}
tokens are (in this case) equivalent to one. 
A slightly modified definition for the line end as
\begin{verbatim}
\def^^M{\par\leavevmode}
\end{verbatim}
remedies this:
now every line end forces \TeX\ to start a paragraph. For empty
lines this will then be an empty paragraph.

%%\spoint Changing the \cs{\endlinechar}
%\subsection{Changing the \cs{endlinechar}}
%\spoint Changing the \cs{\endlinechar}
\subsection{Changing the \cs{endlinechar}}

%Occasionally you may want to change the \cs{endlinechar}, or
%the \cs{catcode} of the ordinary line terminator \verb.^^M.,
%for instance to obtain special effects such as macros where 
%the argument is terminated by the line end.
%See page~\pageref{pick:eol} for a worked-out example.
Occasionally you may want to change the \cs{endlinechar}, or
the \cs{catcode} of the ordinary line terminator \verb.^^M.,
for instance to obtain special effects such as macros where 
the argument is terminated by the line end.
See page~\pageref{pick:eol} for a worked-out example.

%There are  a couple of traps. Consider the following:
%\begin{verbatim}
%{\catcode`\^^M=12 \endlinechar=`\^^J \catcode`\^^J=5
%...
%... }
%\end{verbatim}
%This causes unintended output of both character~13 (\verb-^^M-)
%and~10 (\verb-^^J-), caused by the line terminators of the
%first and last line.
There are  a couple of traps. Consider the following:
\begin{verbatim}
{\catcode`\^^M=12 \endlinechar=`\^^J \catcode`\^^J=5
...
... }
\end{verbatim}
This causes unintended output of both character~13 (\verb-^^M-)
and~10 (\verb-^^J-), caused by the line terminators of the
first and last line.

%Terminating the first and  last line with a comment works,
%but replacing the first line by the two lines
%\begin{verbatim}
%{\endlinechar=`\^^J \catcode`\^^J=5
%\catcode`\^^M=12
%\end{verbatim}
%is also a solution.
Terminating the first and  last line with a comment works,
but replacing the first line by the two lines
\begin{verbatim}
{\endlinechar=`\^^J \catcode`\^^J=5
\catcode`\^^M=12
\end{verbatim}
is also a solution.

%Of course, in many cases it is not necessary to substitute
%another end-of-line character; a~much simpler solution 
%is then to put
%\begin{verbatim}
%\endlinechar=-1 
%\end{verbatim}
%which treats all lines as if they end with a comment.
Of course, in many cases it is not necessary to substitute
another end-of-line character; a~much simpler solution 
is then to put
\begin{verbatim}
\endlinechar=-1 
\end{verbatim}
which treats all lines as if they end with a comment.

%%\spoint More remarks about the end-of-line character
%\subsection{More remarks about the end-of-line character}
%\spoint More remarks about the end-of-line character
\subsection{More remarks about the end-of-line character}

%The character that \TeX\ appends at the end of an input line
%is treated like any other character. Usually one is not aware
%of this, as its category code is special, but there are a few
%ways to let it be processed in an unusual way.
The character that \TeX\ appends at the end of an input line
is treated like any other character. Usually one is not aware
of this, as its category code is special, but there are a few
ways to let it be processed in an unusual way.

%\begin{example} Terminating an input line with \verb>^^> will
%(ordinarily, when \cs{endlinechar} is~13) give `M' in the output, 
%which is the 
%\ascii{} character with code~13+64.
%\end{example}
\begin{example} Terminating an input line with \verb>^^> will
(ordinarily, when \cs{endlinechar} is~13) give `M' in the output, 
which is the 
\ascii{} character with code~13+64.
\end{example}

%\begin{example} If \verb>\^^M> has been defined,
%terminating an input line with a backslash will execute this command.
%The plain format defines
%\begin{verbatim}
%\def\^^M{\ }
%\end{verbatim}
%which makes a `control return' equivalent to a control space.
%\end{example}
\begin{example} If \verb>\^^M> has been defined,
terminating an input line with a backslash will execute this command.
The plain format defines
\begin{verbatim}
\def\^^M{\ }
\end{verbatim}
which makes a `control return' equivalent to a control space.
\end{example}

%%\point More about the input processor
%\section{More about the input processor}
%\point More about the input processor
\section{More about the input processor}

%%\spoint The input processor as a separate process
%\subsection{The input processor as a separate process}
%\spoint The input processor as a separate process
\subsection{The input processor as a separate process}

%\TeX's levels of processing are all working at the
%same time and incrementally, but conceptually they can often be
%considered to be separate processes that each accept the
%completed output of the previous stage. The juggling with
%spaces provides a nice illustration for this.
\TeX's levels of processing are all working at the
same time and incrementally, but conceptually they can often be
considered to be separate processes that each accept the
completed output of the previous stage. The juggling with
spaces provides a nice illustration for this.

%Consider the definition
%\begin{verbatim}
%\def\DoAssign{\count42=800}
%\end{verbatim}
%and the call
%\begin{verbatim}
%\DoAssign 0
%\end{verbatim}
%The input processor, the part
%of \TeX\ that builds tokens, in scanning this call
%skips the space before the zero, so the expansion of this
%call is
%\begin{verbatim}
%\count42=8000
%\end{verbatim}
%It would be incorrect to reason
%`\cs{DoAssign} is read, then expanded, the space delimits the
%number 800, so 800 is assigned and the zero is printed'.
%Note that the same would happen if the zero appeared on the next line.
Consider the definition
\begin{verbatim}
\def\DoAssign{\count42=800}
\end{verbatim}
and the call
\begin{verbatim}
\DoAssign 0
\end{verbatim}
The input processor, the part
of \TeX\ that builds tokens, in scanning this call
skips the space before the zero, so the expansion of this
call is
\begin{verbatim}
\count42=8000
\end{verbatim}
It would be incorrect to reason
`\cs{DoAssign} is read, then expanded, the space delimits the
number 800, so 800 is assigned and the zero is printed'.
Note that the same would happen if the zero appeared on the next line.

%Another illustration shows that optional spaces appear in a different
%stage of processing from that for skipped spaces:
%\begin{disp}\verb>\def\c.{\relax}>\nl
%     \verb>a\c.>{\tt\char32 b}\end{disp}
%expands to
%\begin{disp}\n{a\cs{relax}\char32 b}\end{disp}
%which gives as output\begin{disp} `a b'\end{disp}
%because spaces after the \cs{relax} control sequence are only
%skipped when the line is first read, not when it is expanded.
%The fragment
%\begin{disp} \verb-\def\c.{\ignorespaces}-\nl \verb-a\c. b-\end{disp}
%on the other hand, expands to
%\begin{disp}\n{a\cs{ignorespaces}\char32 b}\end{disp}
%Executing the \cs{ignorespaces} command removes the subsequent
%space token, so the output is \begin{disp} `ab'.\end{disp}
%In both definitions
%the period after \cs{c} is a delimiting token; it is used here
%to prevent spaces from being skipped.
Another illustration shows that optional spaces appear in a different
stage of processing from that for skipped spaces:
\begin{disp}\verb>\def\c.{\relax}>\nl
     \verb>a\c.>{\tt\char32 b}\end{disp}
expands to
\begin{disp}\n{a\cs{relax}\char32 b}\end{disp}
which gives as output\begin{disp} `a b'\end{disp}
because spaces after the \cs{relax} control sequence are only
skipped when the line is first read, not when it is expanded.
The fragment
\begin{disp} \verb-\def\c.{\ignorespaces}-\nl \verb-a\c. b-\end{disp}
on the other hand, expands to
\begin{disp}\n{a\cs{ignorespaces}\char32 b}\end{disp}
Executing the \cs{ignorespaces} command removes the subsequent
space token, so the output is \begin{disp} `ab'.\end{disp}
In both definitions
the period after \cs{c} is a delimiting token; it is used here
to prevent spaces from being skipped.

%%\spoint The input processor not as a separate process
%\subsection{The input processor not as a separate process}
%\spoint The input processor not as a separate process
\subsection{The input processor not as a separate process}

%Considering the tokenizing of \TeX\ to be a separate process
%is a convenient view, but sometimes it leads to confusion.
%The line
%\begin{verbatim}
%\catcode`\^^M=13{}
%\end{verbatim}
%makes the line end active,
%and subsequently gives an `undefined control sequence' error
%for the line end of this line itself. Execution of the commands
%on the line thus influences the scanning process of that
%same line.
Considering the tokenizing of \TeX\ to be a separate process
is a convenient view, but sometimes it leads to confusion.
The line
\begin{verbatim}
\catcode`\^^M=13{}
\end{verbatim}
makes the line end active,
and subsequently gives an `undefined control sequence' error
for the line end of this line itself. Execution of the commands
on the line thus influences the scanning process of that
same line.

%By contrast,
%\begin{verbatim}
%\catcode`\^^M=13
%\end{verbatim}
%does not give an error.
%The reason for this is that \TeX\ reads the line end while it is still
%scanning the number~13; that is, at a time when the assignment
%has not been performed yet.
%The line end is then converted to the optional space character
%delimiting the number to be assigned.
By contrast,
\begin{verbatim}
\catcode`\^^M=13
\end{verbatim}
does not give an error.
The reason for this is that \TeX\ reads the line end while it is still
scanning the number~13; that is, at a time when the assignment
has not been performed yet.
The line end is then converted to the optional space character
delimiting the number to be assigned.

%%\spoint Recursive invocation of the input processor
%\subsection{Recursive invocation of the input processor}
%\spoint Recursive invocation of the input processor
\subsection{Recursive invocation of the input processor}

%Above, the activity of replacing a parameter
%character plus a digit by a parameter token was described
%as something similar to the lumping together of letters
%into  a control sequence token. Reality is somewhat more
%complicated than this. \TeX's token scanning mechanism
%is invoked both for input from file and for input from
%lists of tokens such as the macro definition. Only in the
%first case is the terminology of internal states applicable.
Above, the activity of replacing a parameter
character plus a digit by a parameter token was described
as something similar to the lumping together of letters
into  a control sequence token. Reality is somewhat more
complicated than this. \TeX's token scanning mechanism
is invoked both for input from file and for input from
lists of tokens such as the macro definition. Only in the
first case is the terminology of internal states applicable.

%Macro parameter characters are treated the same in both
%cases, however. If this were not the case it would
%not be possible to write things such as
%\begin{verbatim}
%\def\a{\def\b{\def\c####1{####1}}}
%\end{verbatim}
%See page \pageref{nest:def} for an explanation of such
%nested definitions.
Macro parameter characters are treated the same in both
cases, however. If this were not the case it would
not be possible to write things such as
\begin{verbatim}
\def\a{\def\b{\def\c####1{####1}}}
\end{verbatim}
See page \pageref{nest:def} for an explanation of such
nested definitions.

%%\point The \verb@- convention
%\section{The \n{@} convention}
%\point The \verb@- convention
\section{The \n{@} convention}

%Anyone who has ever browsed through either the plain format or
%the \LaTeX\ format will have noticed that a lot of control sequences
%contain an `at' sign:~\verb-@-. These are control sequences that
%are meant to be inaccessible to the ordinary user.
Anyone who has ever browsed through either the plain format or
the \LaTeX\ format will have noticed that a lot of control sequences
contain an `at' sign:~\verb-@-. These are control sequences that
are meant to be inaccessible to the ordinary user.

%Near the beginning of the format files the instruction
%\begin{verbatim}
%\catcode`@=11
%\end{verbatim}
%occurs, making the at sign into a letter,
%meaning that it can be used in control sequences. Somewhere near the
%end of the format definition the at sign is made `other' again:
%\begin{verbatim}
%\catcode`@=12
%\end{verbatim}
Near the beginning of the format files the instruction
\begin{verbatim}
\catcode`@=11
\end{verbatim}
occurs, making the at sign into a letter,
meaning that it can be used in control sequences. Somewhere near the
end of the format definition the at sign is made `other' again:
\begin{verbatim}
\catcode`@=12
\end{verbatim}

%Now why is it that users cannot
%call a control sequence with an at sign
%directly, although they can call macros that contain lots of those
%`at-definitions'? The reason is that the control sequences
%containing an \n@ are internalized by \TeX\ at definition time,
%after which they are a token, not a string of characters. 
%Macro expansion then
%just inserts such tokens, and at that time the category codes
%of the constituent characters do not matter any more.
Now why is it that users cannot
call a control sequence with an at sign
directly, although they can call macros that contain lots of those
`at-definitions'? The reason is that the control sequences
containing an \n@ are internalized by \TeX\ at definition time,
after which they are a token, not a string of characters. 
Macro expansion then
just inserts such tokens, and at that time the category codes
of the constituent characters do not matter any more.

%\endofchapter
%%%%% end of input file [mouth]
\endofchapter
%%%% end of input file [mouth]

\end{document}
